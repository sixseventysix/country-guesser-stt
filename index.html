<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country Name Guesser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .country {
            fill: #cccccc; /* Default gray for unguessed */
            stroke: #ffffff;
            stroke-width: 0.5;
            transition: fill 0.3s ease-in-out;
        }
        .country.guessed {
            fill: #4ade80; /* Green for guessed */
        }
        /* Style for number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4 text-gray-800">

    <div class="w-full max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <div class="text-center mb-4">
            <h1 class="text-3xl font-bold text-gray-900">Country Name Guesser</h1>
            <p class="text-gray-600">Set a duration, click Start, and say a country's name!</p>
        </div>

        <!-- Game Controls and Status -->
        <div class="flex flex-col md:flex-row items-center justify-between mb-4 bg-gray-50 p-4 rounded-lg">
            <div class="flex items-center space-x-4">
                <button id="startButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all duration-300">
                    Start Game
                </button>
                <!-- UPDATED: Integer Input for Duration -->
                <div class="flex items-center space-x-2">
                    <label for="durationInput" class="text-sm font-medium text-gray-700">Duration (s):</label>
                    <input type="number" id="durationInput" value="60" min="10" max="300" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 w-20 text-center">
                </div>
            </div>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div id="status" class="text-lg font-medium text-gray-700 hidden md:block">Press Start to Play</div>
                 <div class="text-center">
                    <div class="text-3xl font-bold text-red-500" id="timer">60</div>
                    <div class="text-sm text-gray-500">Seconds Left</div>
                </div>
                 <div class="text-center">
                    <div class="text-3xl font-bold text-green-500" id="score">0</div>
                    <div class="text-sm text-gray-500">Countries Guessed</div>
                </div>
            </div>
        </div>

        <!-- World Map Container -->
        <div id="map-container" class="w-full h-[600px] border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
            <!-- SVG World Map will be loaded here -->
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const timerDiv = document.getElementById('timer');
        const scoreDiv = document.getElementById('score');
        const mapContainer = document.getElementById('map-container');
        const durationInput = document.getElementById('durationInput'); // Updated element

        // --- Game State ---
        let websocket;
        let audioContext;
        let mediaStream;
        let processor;
        let isRecording = false;
        let timerInterval;
        let timeLeft = 60;
        let score = 0;

        // --- WebSocket and Audio Handling ---
        
        async function setupAudioAndWebSocket() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                statusDiv.textContent = 'Microphone connected.';
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(mediaStream);
                processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = (event) => {
                    if (!isRecording) return;
                    const inputData = event.inputBuffer.getChannelData(0);
                    const buffer = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        buffer[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7FFF;
                    }
                    if(websocket && websocket.readyState === WebSocket.OPEN) {
                        websocket.send(buffer.buffer);
                    }
                };

                source.connect(processor);
                processor.connect(audioContext.destination);
                
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                websocket = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

                websocket.onopen = () => console.log('WebSocket connection established.');
                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'guess') {
                        updateMap(data.country);
                        updateScore();
                    }
                };
                websocket.onclose = () => {
                    console.log('WebSocket connection closed.');
                    if (isRecording) stopGame('Connection lost.');
                };
                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    statusDiv.textContent = 'Error connecting. Please refresh.';
                };

            } catch (err) {
                console.error('Error accessing microphone:', err);
                statusDiv.textContent = 'Microphone access denied. Please allow it and refresh.';
                throw err;
            }
        }
        
        // --- Game Logic ---
        
        async function startGame() {
            if (isRecording) return;
            
            // Get duration from text input and validate it
            let selectedDuration = parseInt(durationInput.value, 10);
            if (isNaN(selectedDuration) || selectedDuration < 2 || selectedDuration > 6000) {
                selectedDuration = 600; // Default to 60 if input is invalid
                durationInput.value = 60;
            }
            timeLeft = selectedDuration;
            timerDiv.textContent = timeLeft;
            score = 0;
            scoreDiv.textContent = score;
            resetMap();
            
            statusDiv.textContent = 'Connecting...';
            startButton.disabled = true;
            durationInput.disabled = true; // Disable input during game

            try {
                await setupAudioAndWebSocket();
                isRecording = true;
                startButton.textContent = 'Listening...';
                statusDiv.textContent = 'Listening... Speak now!';
                startTimer();
            } catch (error) {
                stopGame('Setup failed. Please try again.');
            }
        }
        
        function stopGame(message = 'Time\'s up!') {
            isRecording = false;
            clearInterval(timerInterval);
            statusDiv.textContent = `${message} Final Score: ${score}`;
            startButton.disabled = false;
            durationInput.disabled = false; // Re-enable input
            startButton.textContent = 'Start Game';
            
            if (websocket) websocket.close();
            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
            if (audioContext && audioContext.state !== 'closed') audioContext.close();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDiv.textContent = timeLeft;
                if (timeLeft <= 0) {
                    stopGame();
                }
            }, 1000);
        }
        
        function updateScore() {
            score++;
            scoreDiv.textContent = score;
        }
        
        // --- Map Handling ---

        function updateMap(countryName) {
            const countryId = countryName.replace(/\s+/g, '-').toLowerCase();
            const countryElement = document.getElementById(countryId);
            if (countryElement) {
                countryElement.classList.add('guessed');
            } else {
                console.warn(`Could not find map element for country: ${countryName}`);
            }
        }

        function resetMap() {
            const guessedCountries = document.querySelectorAll('.country.guessed');
            guessedCountries.forEach(el => el.classList.remove('guessed'));
        }
        
        async function loadMap() {
            try {
                const response = await fetch('https://unpkg.com/world-atlas@2.0.2/countries-110m.json');
                const worldData = await response.json();
                
                const {feature} = await import('https://unpkg.com/topojson-client@3.1.0/src/index.js');
                const countries = feature(worldData, worldData.objects.countries);

                const width = 960, height = 500;
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                
                const projection = (coords) => {
                    const [lon, lat] = coords;
                    const x = (lon + 180) * (width / 360);
                    const y = (height / 2) - (height * lat / 180);
                    return [x, y];
                }
                
                countries.features.forEach(c => {
                    const countryName = c.properties.name.toLowerCase();
                    const countryId = countryName.replace(/\s+/g, '-');
                    if (c.geometry) {
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        path.setAttribute('id', countryId);
                        path.setAttribute('class', 'country');
                        let d = '';
                        const processCoords = (rings) => rings.forEach(ring => { d += 'M' + ring.map(projection).join('L') + 'Z'; });
                        if (c.geometry.type === 'Polygon') processCoords(c.geometry.coordinates);
                        else if (c.geometry.type === 'MultiPolygon') c.geometry.coordinates.forEach(processCoords);
                        path.setAttribute('d', d);
                        svg.appendChild(path);
                    }
                });
                mapContainer.innerHTML = '';
                mapContainer.appendChild(svg);
            } catch (error) {
                console.error('Error loading map data:', error);
                mapContainer.textContent = 'Failed to load world map.';
            }
        }
        
        // --- Event Listeners ---
        startButton.addEventListener('click', startGame);
        
        // UPDATED: Update timer display when duration is changed
        durationInput.addEventListener('input', (event) => {
            if (!isRecording) {
                const val = parseInt(event.target.value, 10);
                if (!isNaN(val) && val >= 10 && val <= 300) {
                    timerDiv.textContent = val;
                } else if (event.target.value === "") {
                     timerDiv.textContent = "0"; // Show 0 if input is empty
                }
            }
        });

        window.addEventListener('load', loadMap);
    </script>
</body>
</html>
